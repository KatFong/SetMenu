<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐單生成器</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>餐單生成器</h1>
        </div>

        <div class="card menu-generator">
            <div class="customer-select-group">
                <div class="select-wrapper">
                    <select id="customerSelect" onchange="loadCustomerData()">
                        <option value="">新增客人</option>
                    </select>
                </div>
                <button onclick="showEditModal()" class="edit-btn" id="editBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16">
                        <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    編輯
                </button>
            </div>

            <div id="customerInfo" class="customer-info" style="display: none;">
                <h3>客人資料</h3>
                <p id="customerNotes"></p>
            </div>

            <div class="input-group">
                <label for="ingredients">現有食材</label>
                <textarea id="ingredients" 
                          placeholder="請輸入現有的食材，每個食材用逗號分隔"></textarea>
            </div>

            <div class="input-group">
                <label for="budget">預算 (HKD)</label>
                <input type="number" id="budget" placeholder="例如：2000" min="0" step="100" required>
            </div>

            <div class="input-group">
                <label for="people">預計人數</label>
                <input type="number" id="people" placeholder="例如：10" min="1" required>
            </div>

            <button onclick="generateMenu()" class="generate-btn">生成餐單</button>
            
            <div class="loading" id="loading">正在生成餐單中</div>
            <div id="result"></div>
        </div>
    </div>

    <!-- 編輯客人資料的模態框 -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>編輯客人資料</h2>
            
            <div class="input-group">
                <label for="customerName">客人姓名</label>
                <input type="text" id="customerName" placeholder="請輸入客人姓名">
            </div>
            
            <div class="input-group">
                <label for="notes">備注</label>
                <textarea id="notes" 
                          placeholder="客人喜好及其他重要備注，例如：不吃辣、喜歡海鮮、避免花生、VIP客人等"></textarea>
            </div>

            <div class="modal-buttons">
                <button onclick="saveCustomer()" class="save-btn">儲存</button>
                <button onclick="deleteCustomer()" class="delete-btn" id="deleteBtn">刪除</button>
            </div>
        </div>
    </div>

    <script>
        let currentCustomerId = null;
        let keepItems = [];
        let menuData = null;
        let currentMenuItems = [];

        function loadCustomerSelect() {
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const select = document.getElementById('customerSelect');
            select.innerHTML = '<option value="">新增客人</option>' + 
                customers.map(customer => 
                    `<option value="${customer.id}">${customer.customerName}</option>`
                ).join('');
        }

        function loadCustomerData() {
            const customerId = document.getElementById('customerSelect').value;
            const customerInfo = document.getElementById('customerInfo');
            const editBtn = document.getElementById('editBtn');
            
            if (!customerId) {
                // 新增客人模式
                currentCustomerId = null;
                customerInfo.style.display = 'block'; // 顯示客人資料框
                customerInfo.innerHTML = `
                    <h3>新增客人資料</h3>
                    <div class="input-group">
                        <label for="newCustomerName">客人姓名</label>
                        <input type="text" id="newCustomerName" placeholder="請輸入客人姓名">
                    </div>
                    <div class="input-group">
                        <label for="newCustomerNotes">備注</label>
                        <textarea id="newCustomerNotes" 
                            placeholder="客人喜好及其他重要備注，例如：不吃辣、喜歡海鮮、避免花生、VIP客人等"></textarea>
                    </div>
                    <button onclick="quickSaveCustomer()" class="save-btn">儲存客人資料</button>
                `;
                editBtn.style.display = 'none';
                return;
            }

            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const customer = customers.find(c => c.id === customerId);
            
            if (customer) {
                currentCustomerId = customer.id;
                customerInfo.innerHTML = `
                    <h3>客人資料</h3>
                    <p class="customer-notes">${customer.notes || '無備注'}</p>
                `;
                customerInfo.style.display = 'block';
                editBtn.style.display = 'inline-block';
            }
        }

        // 添加快速儲存客人資料的函數
        function quickSaveCustomer() {
            const customerName = document.getElementById('newCustomerName').value;
            const notes = document.getElementById('newCustomerNotes').value;

            if (!customerName) {
                alert('請輸入客人姓名');
                return;
            }

            const customerData = {
                id: Date.now().toString(),
                customerName,
                notes,
                lastUpdated: new Date().toISOString()
            };

            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            customers.push(customerData);
            localStorage.setItem('customers', JSON.stringify(customers));

            // 更新選單並選中新客人
            loadCustomerSelect();
            document.getElementById('customerSelect').value = customerData.id;
            loadCustomerData();
        }

        function showEditModal() {
            const modal = document.getElementById('editModal');
            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const customer = customers.find(c => c.id === currentCustomerId);
            
            if (customer) {
                document.getElementById('customerName').value = customer.customerName;
                document.getElementById('notes').value = customer.notes || '';
            } else {
                document.getElementById('customerName').value = '';
                document.getElementById('notes').value = '';
            }
            
            modal.style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveCustomer() {
            const customerData = {
                id: currentCustomerId || Date.now().toString(),
                customerName: document.getElementById('customerName').value,
                notes: document.getElementById('notes').value,
                lastUpdated: new Date().toISOString()
            };

            if (!customerData.customerName) {
                alert('請輸入客人姓名');
                return;
            }

            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const existingIndex = customers.findIndex(c => c.id === customerData.id);
            
            if (existingIndex >= 0) {
                customers[existingIndex] = {...customers[existingIndex], ...customerData};
            } else {
                customers.push(customerData);
            }

            localStorage.setItem('customers', JSON.stringify(customers));
            loadCustomerSelect();
            closeEditModal();
            
            // 更新選擇的客人
            document.getElementById('customerSelect').value = customerData.id;
            loadCustomerData();
        }

        function deleteCustomer() {
            if (!currentCustomerId || !confirm('確定要刪除此客人資料嗎？')) {
                return;
            }

            const customers = JSON.parse(localStorage.getItem('customers') || '[]');
            const updatedCustomers = customers.filter(c => c.id !== currentCustomerId);
            localStorage.setItem('customers', JSON.stringify(updatedCustomers));
            
            closeEditModal();
            loadCustomerSelect();
            document.getElementById('customerSelect').value = '';
            loadCustomerData();
        }

        async function generateMenu() {
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const budget = document.getElementById('budget').value;
            const people = document.getElementById('people').value;
            
            // 可選欄位
            const customerName = document.getElementById('customerName').value;
            const notes = document.getElementById('notes').value;
            const ingredients = document.getElementById('ingredients').value;

            if (!budget || !people) {
                alert('請填寫預算和預計人數');
                return;
            }

            loading.style.display = 'block';
            result.style.display = 'none';

            try {
                const promptText = `作為一個餐飲專家，請根據以下要求生成到會餐單：
                    ${customerName ? `客人姓名：${customerName}` : ''}
                    ${notes ? `客人備注：${notes}` : ''}
                    ${ingredients ? `現有食材：${ingredients}` : ''}
                    預算：${budget} HKD
                    預計人數：${people}人
                    要求：
                    1. ${ingredients ? '優先使用現有食材' : '建議多元化的菜品組合'}
                    2. 適合宴會/到會場合使用
                    3. 考慮成本效益和食材新鮮度
                    4. 每道菜需包含價格和建議份量
                    5. ${ingredients ? '建議需要添購的食材' : '建議合適的菜品搭配'}
                    6. ${notes ? '特別考慮客人的飲食喜好和限制' : '提供均衡的菜品搭配'}
                    
                    請只回應以下格式的JSON，不要加入其他文字：
                    {
                        "menu": [
                            {
                                "name": "菜名",
                                "price": 數字,
                                "quantity": 數字
                                ${ingredients ? ',"useExistingIngredients": ["使用的現有食材"]' : ''}
                            }
                        ],
                        "totalPrice": 數字,
                        "recommendedPeople": ${people},
                        ${ingredients ? '"additionalIngredients": ["需要添購的食材"],' : ''}
                        "notes": "建議說明（包含菜品搭配建議和特別注意事項）"
                    }`;

                const response = await fetch(
                    'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=AIzaSyCl78ysJGjkonNy8Ly-rpZJuB5bA2DYeJs',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "contents": [{
                                "parts":[{
                                    "text": promptText
                                }]
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('API 請求失敗');
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                let menuData;
                try {
                    const textContent = data.candidates[0].content.parts[0].text;
                    const jsonStart = textContent.indexOf('{');
                    const jsonEnd = textContent.lastIndexOf('}') + 1;
                    if (jsonStart === -1 || jsonEnd === 0) {
                        throw new Error('回應中未找到有效的 JSON');
                    }
                    const jsonString = textContent.slice(jsonStart, jsonEnd);
                    console.log('準備解析的 JSON:', jsonString);
                    menuData = JSON.parse(jsonString);
                } catch (parseError) {
                    console.error('JSON 解析錯誤:', parseError);
                    console.log('原始回應:', data.candidates[0].content.parts[0].text);
                    throw new Error('無法解析餐單數據');
                }

                if (!menuData || !menuData.menu || !menuData.totalPrice) {
                    console.error('無效的菜單數據:', menuData);
                    throw new Error('餐單數據格式不正確');
                }

                // 解析成功後，更新當前菜單項目
                currentMenuItems = menuData.menu || [];
                
                // 更新顯示模板
                let menuHtml = `
                    <h3>${customerName ? customerName + ' 的' : ''}建議餐單 (${menuData.recommendedPeople} 人)</h3>
                    <div class="menu-section">
                        ${keepItems.length > 0 ? `
                            <div class="kept-items-section">
                                <h4>已選擇的菜品</h4>
                                <div class="selected-items-text">
                                    ${keepItems.map(item => item.name).join('、')}
                                </div>
                                <ul>
                                    ${keepItems.map((item, index) => `
                                        <li class="kept-item">
                                            <div class="menu-item">
                                                <label class="checkbox-label">
                                                    <input type="checkbox" checked onchange="removeKeptItem(${index})">
                                                    <span class="item-name">${item.name} x ${item.quantity} (每份 $${item.price})</span>
                                                </label>
                                            </div>
                                            ${item.useExistingIngredients ? `
                                                <small>使用現有食材: ${item.useExistingIngredients.join(', ')}</small>
                                            ` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="new-items-section">
                            <h4>新建議菜品</h4>
                            <div class="multi-select-controls">
                                <label class="checkbox-label">
                                    <input type="checkbox" onchange="toggleAllItems(this.checked)">
                                    <span>全選</span>
                                </label>
                                <button onclick="keepSelectedItems()" class="keep-selected-btn">保留已選菜品</button>
                            </div>
                            <ul>
                                ${currentMenuItems.map((item, index) => `
                                    <li class="new-item">
                                        <div class="menu-item">
                                            <label class="checkbox-label">
                                                <input type="checkbox" class="menu-item-checkbox" data-index="${index}">
                                                <span class="item-name">${item.name} x ${item.quantity} (每份 $${item.price})</span>
                                            </label>
                                        </div>
                                        ${item.useExistingIngredients ? `
                                            <small>使用現有食材: ${item.useExistingIngredients.join(', ')}</small>
                                        ` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="menu-footer">
                        <p>總預算: $${calculateTotal()}</p>
                        ${menuData.additionalIngredients ? `
                            <p class="additional-ingredients">需要添購的食材: ${menuData.additionalIngredients.join(', ')}</p>
                        ` : ''}
                        ${menuData.notes ? `<p class="notes">${menuData.notes}</p>` : ''}
                    </div>
                    <div class="menu-actions">
                        <button onclick="generateMenu()" class="regenerate-btn">重新生成其他菜品</button>
                        ${keepItems.length > 0 ? `
                            <button onclick="clearKeptItems()" class="clear-btn">清除所有已保留菜品</button>
                        ` : ''}
                    </div>
                `;
                
                result.innerHTML = menuHtml;
                result.classList.add('result-visible');
            } catch (error) {
                console.error('錯誤:', error);
                menuData = null;
                result.innerHTML = `
                    <div class="error-message">
                        <h3>發生錯誤</h3>
                        <p>${error.message}</p>
                        <p>請稍後再試或聯繫支援</p>
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
                result.style.display = 'block';
            }
        }

        function calculateTotal() {
            const keptTotal = keepItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const currentTotal = currentMenuItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            return keptTotal + currentTotal;
        }

        function keepItem(index) {
            if (index >= 0 && index < currentMenuItems.length) {
                const item = currentMenuItems[index];
                keepItems.push(item);
                generateMenu();
            }
        }

        function removeKeptItem(index) {
            if (index >= 0 && index < keepItems.length) {
                keepItems.splice(index, 1);
                generateMenu();
            }
        }

        function clearKeptItems() {
            if (confirm('確定要清除所有已保留的菜品嗎？')) {
                keepItems = [];
                generateMenu();
            }
        }

        function toggleItem(index, checked) {
            if (checked) {
                keepItem(index);
            } else {
                const item = currentMenuItems[index];
                const keepIndex = keepItems.findIndex(kept => 
                    kept.name === item.name && 
                    kept.price === item.price && 
                    kept.quantity === item.quantity
                );
                if (keepIndex !== -1) {
                    removeKeptItem(keepIndex);
                }
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeEditModal();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCustomerSelect();
            loadCustomerData();
        });

        function toggleAllItems(checked) {
            const checkboxes = document.querySelectorAll('.menu-item-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = checked);
        }

        function keepSelectedItems() {
            const checkboxes = document.querySelectorAll('.menu-item-checkbox:checked');
            const selectedIndexes = Array.from(checkboxes).map(checkbox => 
                parseInt(checkbox.getAttribute('data-index'))
            );
            
            selectedIndexes.forEach(index => {
                if (index >= 0 && index < currentMenuItems.length) {
                    keepItems.push(currentMenuItems[index]);
                }
            });
            
            generateMenu();
        }
    </script>
</body>
</html> 